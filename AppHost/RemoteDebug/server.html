<!DOCTYPE html>
<html class="hairlines" style="font-size:37.5px">

<head>
    <meta charset="utf-8">
    <title>AppHost Remote Debugger</title>
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="yes" name="apple-touch-fullscreen">
    <meta content="telephone=no,email=no" name="format-detection">
    <meta name="screen-orientation" content="portrait">
    <meta name="x5-orientation" content="portrait">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no">
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }

        .m-output {
            height: 100%;
            width: 100%;
            padding-bottom: 66px;
            box-sizing: border-box;
            font-weight: 200;
            overflow-y: scroll;
            overflow-x: hidden;
        }

        .m-output-result {
            border-bottom: 1px solid #CCCCCC;
            font-size: 12px;
            text-indent: 10px;
        }

        .m-input {
            height: 60px;
            position: fixed;
            background-color: white;
            left: 0;
            bottom: 10px;
            right: 0;
            border-top: 1px dotted #777
        }

        .m-input .w-command {
            width: 100%;
            height: 50px;
            padding: 0;
            margin: 0;
            border: none;
            /* border: 1px solid #ff00ff; */
            border-right: 100px solid #fff;
            overflow: hidden;
            font-size: 24px;
            font-weight: 200;
            text-indent: 10px;
            box-sizing: border-box;
        }

        .m-input .w-command-run {
            color: #333333;
            position: absolute;
            width: 90px;
            top: 5px;
            right: 5px;
            bottom: 5px;
            font-size: 25px;
            line-height: 38px;
            text-align: center;
        }

        .m-output-command {
            width: 100%;
            padding: 0;
            margin: 0;
            border-bottom: 1px dotted #CCCCCC;
            min-height: 30px;
            color: #333333;
            font-size: 12px;
            line-height: 30px;
            text-indent: 10px;
        }

        .w-em-seq {
            color: #777777;
        }

        pre {
            margin-top: 0;
            padding-left: 15px;
        }

        .m-output-type {
            margin-top: 5px;
            text-indent: 5px;
            text-decoration: underline;
        }

        .w-help-code {
            background-color: #333333;
            color: #fff;
            font-size: 14px;
            padding: 12px;
            font-weight: 400;
            font-family: monospace;
        }

        .w-err-code {
            color: #de3535;
            font-size: 14px;
        }
    </style>
    <link href="./renderjson.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="./renderjson.js" charset="utf-8"></script>
    <script type="text/javascript" charset="utf-8">
        window.appHost = {
            invoke: function (action, param) {
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/command.do', true);
                xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhr.onload = function () {
                    console.log(xhr.responseURL); // http://example.com/test
                };

                xhr.send('action=' + action + '&param=' + encodeURI(window.JSON.stringify(param)));
            }
        }

        window.kIndex = 1;

        var divEle = function (classname) {
            var s = document.createElement("div");
            if (classname) s.className = classname;
            return s;
        };

        function appendLog(logs) {
            var output = document.getElementById('output');
            for (var i = 0; i < logs.length; i++) {
                var log = window.JSON.parse(logs[i]);
                var logType = log.type;
                var logVal = log.value;

                var result = divEle('m-output-result');
                // 先显示日志类型，
                var logTypeEle = divEle('m-output-type');
                logTypeEle.insertAdjacentHTML('beforeend', '输出类型：' + logType.toLocaleUpperCase());
                result.appendChild(logTypeEle);

                var row = result.appendChild(renderjson.set_icons('+', '-').set_show_to_level(2)(logVal));
                output.appendChild(result);
            }
            scrollToBottom();
        }

        function appendCommand(command) {
            var output = document.getElementById('output');
            var e = '';
            e += '<p class="m-output-command"><span class="w-em-seq">&gt;&gt; ' + (window.kIndex++) + ': </span>' +
                command + '</p>';
            output.insertAdjacentHTML('beforeend', e);

            scrollToBottom();
        }

        function loop() {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/react_log.do', true);
            xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            xhr.responseType = 'json'
            xhr.onload = function () {
                console.log(xhr.response);
                var json = xhr.response;
                if (json.code == 'OK') {
                    var data = json.data;
                    if (data) {
                        var logs = data.logs;
                        if (logs.length > 0) {
                            appendLog(logs);
                        }
                    }
                }
            };
            xhr.send('');
        }

        function scrollToBottom() {

            // scroll to bottom
            var output = document.getElementById('output');
            output.scrollTop = output.scrollHeight;
        }

        function showHelp() {
            var output = document.getElementById('output');
            var e = '<p class="m-output-command"> 调用方式同 h5 接口，如: </p><div class="w-help-code">' + "window.appHost.invoke('startNewPage', {'url': 'http://dashi.mail.163.com', 'title': 'title', 'type': 'push','actionTitle':'发布'});" +
                '</div>';
            output.insertAdjacentHTML('beforeend', e);
            scrollToBottom();
        }

        function showError(error) {
            var output = document.getElementById('output');
            var e = '<p class="m-output-command"> 输入有误，错误: <span class="w-err-code">' + error.message +
                '</span></p>';
            output.insertAdjacentHTML('beforeend', e);

            scrollToBottom();
        }
        function showEvalResult(result) {
            var output = document.getElementById('output');
            var e = '<p class="m-output-command"> 执行结果是: ' + result + '</p>';
            output.insertAdjacentHTML('beforeend', e);

            scrollToBottom();
        }

        document.addEventListener("DOMContentLoaded", function (event) {
            console.log("DOM ready!");
            window.setInterval(loop, 1000);

            // 执行命令 
            var command = document.getElementById('command');
            var run = document.getElementById('run');
            run.onclick = function (e) {
                var com = command.value;
                if (com.length > 0) {
                    command.value = '';
                    if (com == ':help') {
                        showHelp();
                    } else {
                        appendCommand(com);
                        try {
                            var r = eval(com);
                            if (r) {
                                showEvalResult(r);
                            }
                        } catch (error) {
                            if (error) {
                                showError(error)
                            }
                        }
                    }

                } else {
                    alert('请输入命令');
                }
            }

            command.onkeyup = function (e) {
                if (e.keyCode === 13) {
                    run.click();
                }

                return true;
            }
        });


        document.addEventListener("readystatechange", function (event) {
            console.log("readystatechange!" + document.readyState);
            if (document.readyState == 'complete') {
                // jsdebugger
                window.__bri = -1;

                function jdb(line) {
                    // do a thing, possibly async, then…
                    if (window.__bri == line) {
                        window.alert('Stop at Debugger;');
                    } else {
                        console.log('Skip at line ' + line);
                    }
                }
                var command = document.getElementById('command'); jdb(0);
                var run = document.getElementById('run'); jdb(1);
                var a = 10; jdb(2)
                var c = 9; jdb(3)
                a = a + ~c + 1; jdb(4)
                console.log(a); jdb(5)

                // run.onclick = function (e) {
                //     var com = command.value; jdb(6);
                //     if (com.length > 0) {
                //         eval(com); jdb(7);
                //     } else {
                //         alert('请输入命令'); jdb(8);
                //     }
                // }
            }
        });
    </script>
</head>

<body>
    <div class="m-output" id="output">
    </div>
    <div class="m-input">
        <input id="command" class="w-command" type="text" name="command" placeholder="输入命令，如. :help" />
        <a id="run" class="w-command-run" value="Run">Run</a>
    </div>
</body>

</html>